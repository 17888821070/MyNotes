## <font color="red">* 1、在一个很大的ip登录日志文件中找出前K个登录次数最多的ip</font>

> log文件大小:100G
>
> 内存大小限制：100M

### 1.1 文件拆分：将ip按照hashcode拆分成若干个小的文件

* 小文件个数：100G/100M =1000片 为防止某个分片数据过多，分成2000片
* 遍历一次所有的log中的ip，将ip读成字符串，求字符串的hashcode，放到block+hashcode/2000.log中

```java
/**
* 将数据切片 分配到小文件中
*/
private static void cutBlock() {
    try {
        int i = 0;
        // 用BufferReader读取每一行数据
        BufferedReader br = new BufferedReader(new InputStreamReader(new FileInputStream("D:\\temp\\log.txt")));
        String line = null;
        while ((line = br.readLine()) != null) {
            System.out.println(++i);
            // 获得hash码 获取对应的文件
            int hash = Objects.hash(line) % 2000;
            // hash有可能为负数
            int fileIndex = (hash >= 0) ? hash : -hash;
            // 将数据写入到片中
            FileUtils.write(new File("D:\\temp\\block" + fileIndex + ".txt"), line + "\n", "UTF-8", true);
        }
    } catch (IOException e) {
        e.printStackTrace();
    }
}
```

### 1.2 单文件排序：找到单个文件访问最多的k个放到汇总文件中

* 读取单个小文件，使用map记录每个ip的个数，将其排序，最高的k个存储到汇总文件中

```java
/**
* 将小文件进行排序取值
*/
private static void map() {
    int f = 0;
    for (File file : new File("D:\\temp\\block").listFiles()) {
        System.out.println("已处理的文件数量: " + (++f));
        try {
            // 统计IP出现次数
            Map<String, Integer> map = new HashMap<>();
            FileUtils.readLines(file, "UTF-8").forEach(s -> {
                if (map.containsKey(s)) {
                    map.put(s, map.get(s) + 1);
                } else {
                    map.put(s, 1);
                }
            });
            // 用Stream对Map进行倒排序 获得IP出现次数最多的三条数据
            map.entrySet().stream().sorted(Collections.reverseOrder(Map.Entry.comparingByValue())).limit(3).forEachOrdered(e -> {
                try {
                    // 将前三的数据写入到map文件中
                    FileUtils.write(new File("D:\\temp\\block\\map.txt"), e.getKey() + "\t" + e.getValue() + "\n", "UTF-8", true);
                } catch (IOException e1) {
                    e1.printStackTrace();
                }
            });
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

### 1.3 汇总文件排序：找到汇总文件中访问次数最多的k个

* 将汇总文件的ip和访问次数读到map，排序，得到访问次数最多的k个

```java
/**
* 将map数据进行排序 取最终结果
*/
private static void reduce() {
    try {
        Map<String, Integer> map = new HashMap<>();
        // 获得map中IP出现的次数
        FileUtils.readLines(new File("D:\\temp\\block\\map.txt"), "UTF-8").forEach(s -> {
            String[] split = s.split("\t");
            map.put(split[0], Integer.valueOf(split[1]));
        });
        // 用Stream对Map进行倒排序 获得IP出现次数最多的三条数据
        map.entrySet().stream().sorted(Collections.reverseOrder(Map.Entry.comparingByValue())).limit(3).forEach(e -> {
            try {
                // 将前三数据写到reduce文件中
                FileUtils.write(new File("D:\\temp\\block\\reduce.txt"), e.getKey() + "\t" + e.getValue() + "\n", "UTF-8", true);
            } catch (IOException e1) {
                e1.printStackTrace();
            }
        });
    } catch (IOException e) {
        e.printStackTrace();
    }
}
```







