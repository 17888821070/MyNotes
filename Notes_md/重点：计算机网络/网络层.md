# 网络层

* 网络层使用IP协议，IP协议基于IP地址转发IP数据报数据

## 1. 相关协议：

#### 1. 1 地址解析协议ARP：

* 内存中存有网络中MAC和IP的缓存，在发送端发送数据时需要根据IP获取到MAC，用于数据链路层的MAC帧封装。
* 如果在内存中还没有缓存时
  1. 需要发送方A向网络中**广播** **目标ip，自身IP和MAC**
  2. 网络中如果有对应的ip，该主机B就会接受此数据报，缓存下发送放的IP和MAC，并**私信**给发送方自己的IP和MAC
  3. 发送方A将IP和MAC放入内存，就可以正常向B发送数据了

#### 1. 2 网际报文控制协议ICMP：

* 用于判断网络通不通、主机可不可达、路由是否可用等网络层问题，用于检测网路健康，一旦发现异常导致无法到达目标地址，需要给发送方一个异常通知

* 应用案例：

  * ping：测试网络可达性

  * tracert：用来显示到达目标主机的路径

    ![1598279505437](imgs\1598279505437.png)

    ![1598279567044](imgs\1598279567044.png)

1.3 IGMP，待定

## 2. IP地址的编址方式
###  2.1 分类的IP地址
 * 格式（已成历史）
     * 类型号 网络号 主机号 共32位
      ![](imgs\1598280912470.png)
  * 特殊网络号：全0 表示本网络；全1 表示本机软件测试的网络号，不发送到网络
  * 特殊主机号：全0 表示所在网络；全1 表示所在网络的所有主机
    ![](imgs\1598280997520.png)
* 互联网IP地址举例
![ce273dcf06ebd73cc538190b0cf9745b.png](imgs\1598281027865.png)

### 2.2 子网的划分
将一个网络划分为多个子网，使其成为不同的网络
* 格式
    * 网络号 子网号 主机号
* 子网掩码
    * 为路由器寻找具体主机提供支持
    * A类地址的默认子网掩码是255.0.0.0，或0xFF000000；
    * B类地址的默认子网掩码是255.255.0.0，或0xFFFF0000；
    * C类地址的默认子网掩码是255.255.255.0，或0xFFFFFF00。
* ip地址与子网掩码的结果为所在子网地址
* 划分子网
    * A类划分子网可以用子网掩码（子网个数为2^子网号1个数-2，主机数为2^主机数-2）
        * 01111111.10000000.0000000.00000000
        * 01111111.11000000.0000000.00000000
        * 01111111.11100000.0000000.00000000
        ...
    * B类划分子网可以用子网掩码（子网个数为2^子网号1个数-2，主机数为2^主机数-2）
        * 01111111.11111111.10000000.00000000
        * 01111111.11111111.11000000.00000000
        * 01111111.11111111.11100000.00000000
        ...
    * C类划分子网可以用子网掩码（子网个数为2^子网号1个数-2，主机数为2^主机数-2）
        * 01111111.11111111.11111111.10000000
        * 01111111.11111111.11111111.11000000
        * 01111111.11111111.11111111.11100000
        ...
### 2.3 无分类域间路由选择CIDR构成超网
* 格式
    * 网络前缀 主机号/网络号位数
    * CIDR还使用“斜线记法”(slash notation)，或称为CIDR记法，即在IP地址后面加上斜线“/”，然后写上网络前缀所占的位数。128.14.35.7/20 = **10000000000011100010**001100000111

## 3. IP数据报的格式

| 字段       | 占位大小（位） | 作用                                                         |
| ---------- | -------------- | ------------------------------------------------------------ |
| 版本       | 4位            | 标记IP协议的版本，Ipv4/Ipv6                                  |
| 首部长度   | 4位            | 默认为0101 表示首部长度20字节                                |
| 区分服务   | 8位            | 不常用                                                       |
| 总长度     | 16位           | 首部+数据部分总长度个字节                                    |
| 标识       | 16位           | 用来标识拆分后的数据包属于同一组                             |
| 标志       | 3位            | 最低位为1标示后边还有分片，为0标示是最后一片；中间位为1表示不能再分了 |
| 偏移量     | 13位           | 用于标志某一个分片数据属于原数据的相对位置（是相对原位置的字节数/8） |
| 生存时间   | 8位            | 表示数据报能在网络中被路由器转发的次数，转发一次就减1给下一个节点 |
| 协议       | 8位            | 表示使用ip数据报的协议类型                                   |
| 首部检验和 | 16位           | 用于检验头部数据得正确性                                     |
| 源地址     | 32位           | 本机ip                                                       |
| 目标地址   | 32位           | 目标ip                                                       |

## 4. 特性

* 无连接：发送数据后不对IP数据报状态进行维护
* 不可靠：不保证不丢、不错、不重、不乱序
* 由上层进行差错校验

### 5. 其他常见问题

### 5.1 如何理解IP协议的不可靠和无连接

* 不可靠：不能保证数据能成功到达目标主机，发生错误时丢弃数据报，发送ICMP消息给源主机，可靠性由上层解决
* 无连接：IP协议不维护已发送数据报的状态信息，体现在IP数据可以不按顺序发送和接受

